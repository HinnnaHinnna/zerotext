<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Text Paragraphs with Drag and Drop and Speech</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.speech/1.0.0/p5.speech.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/IDMNYU/p5.js-speech@0.0.3/lib/p5.speech.js"></script>
  <script src="data.json" type="text/javascript"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      line-height: 2.5;
      box-sizing: border-box;
      hyphens: auto;
    }

    :root {
      --maincolor: #0f31f2;
      --sub-color: #9000ff;
      --sub-color2: #001eff;
      --hover-color: #aeafb0;
      --background-color: #ffffff;
      --scrollbar-color: #f1f1f2;
    }

    @font-face {
      font-family: 'Pretendard';
      src: url('https://fastly.jsdelivr.net/gh/Project-Noonnu/noonfonts_2107@1.1/Pretendard.woff') format('woff');
      font-style: normal;
    }

    .text-block-container {
      position: relative;
      display: inline-block;
    }

    .text-block {
      margin-top: 1px;
      width: 10vw;
      height: 30px;
      resize: horizontal;
      overflow: hidden;
      padding-top: 3px;
      padding-left: 6px;
      border-radius: 0px;
      border: 1px solid #efefef;
      background-color: var(--background-color);
      user-select: none;
      white-space: nowrap;
      font-weight: 400;
      color: var(--maincolor);
    }

    .text-block[draggable="true"] {
      cursor: move;
    }

    .tooltip {
      padding: 0px 5px;
      display: none;
      position: absolute;
      top: -25px;
      left: 50%;
      transform: translateX(-50%);
      border-radius: 5px;
      background-color: var(--sub-color);
      color: white;
      font-size: 10px;
      pointer-events: none;
      white-space: nowrap;
      z-index: 10;
      font-weight: 700;
    }

    .text-block-container:hover .tooltip {
      display: block;
    }

    #content {
      margin-bottom: 100px;
      padding-top: 195px;
      width: 100%;
      display: grid;
      grid-template-columns: repeat(50, 1fr);
      grid-auto-rows: minmax(20px, auto);
      gap: 7px;
      overflow: auto;
      font-weight: 400;
      font-size: 10px;
    }

    #bottom-container {
      position: fixed;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100vw;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      transition: transform 0.3s ease;
      font-weight: 400;
      font-size: 11px;
      color: var(--maincolor);
    }

    #bottom-text {
      margin-bottom: 10px;
      padding: 0% 40%;
      width: 100%;
      height: 100%;
      display: flex;
      color: var(--maincolor);
      border-radius: 0px;
      overflow-y: auto;
      position: relative;
      flex-direction: column;
      text-align: justify;
    }

    #summary-container {
      margin: 0px;
      position: fixed;
      top: 280px;
      width: 100vw;
      height: 640px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-between;
      font-size: 11px;
      font-weight: 400;
    }

    #summary-box {
      margin-bottom: 20px;
      margin-top: -33px;
      padding-left: 0%;
      padding-right: 0%;
      width: 100vw;
      display: flex;
      color: var(--sub-color);
      border-radius: 0px;
      overflow-y: auto;
      white-space: pre-wrap;
      position: relative;
      flex-direction: column;
      text-align: center;
    }

    #btn-container {
      bottom: 120px;
      padding-left: 0%;
      width: 100%;
      display: flex;
      align-items: center;
      position: fixed;
      justify-content: center;
      color: #b0b0b0;
    }

    #listen-button,
    #speak-button,
    #stop-button,
    #summarize-button {
      margin: 3px;
      padding: 0px 8px;
      border: none;
      border-radius: 0px;
      background-color: var(--sub-color);
      color: white;
      cursor: pointer;
      font-size: 10px;
      font-weight: 400;
    }

    #listen-button:hover,
    #speak-button:hover,
    #stop-button:hover,
    #summarize-button:hover {
      background-color: #aeafb0;
    }

    #translatedText {
      display: none;
    }

    #content::-webkit-scrollbar,
    #bottom-text::-webkit-scrollbar {
      width: 50%;
    }

    #content::-webkit-scrollbar-thumb,
    #bottom-text::-webkit-scrollbar-thumb {
      height: 10%;
      width: 10%;
      background: #f1f1f2;
    }

    #content::-webkit-scrollbar-track,
    #bottom-text::-webkit-scrollbar-track {
      background: #f1f1f2;
    }

    @media (max-width: 768px) {
      #content {
        margin-top: 10%;
        padding-top: 10%;
        grid-template-columns: repeat(50, 1fr);
      }
    }
  </style>
</head>

<body>
  <div id="summary-container">
    <div id="summary-box" contenteditable="true"></div>
  </div>
  <div id="bottom-container">
    <div id="bottom-text" contenteditable="true">Drop text here...</div>
  </div>
  <div id="content">
  </div>
  <textarea id="translatedText" readonly style="display: none;"></textarea>

  <div id="btn-container">
    <button id="speak-button">Speak</button>
    <button id="listen-button">Listen</button>
    <button id="stop-button">Stop</button>
    <button id="summarize-button">Summarize</button>
  </div>
  <script>
    const OPENAI_API_KEY = 'sk-proj-qmAhGgl1PbCNcFsnAxQtT3BlbkFJHyo5hyF1rCYmITGy3Kja';

    document.addEventListener('DOMContentLoaded', function () {
      const contentDiv = document.getElementById('content');
      const bottomText = document.getElementById('bottom-text');
      const translatedTextElement = document.getElementById('translatedText');
      const listenButton = document.getElementById('listen-button');
      const speakButton = document.getElementById('speak-button');
      const stopButton = document.getElementById('stop-button');
      const summarizeButton = document.getElementById('summarize-button');
      const summaryBox = document.getElementById('summary-box');

      let isPaused = false;
      let pausedText = '';
      let speech = new p5.Speech();
      let listeningMode = false;
      let recognition = new p5.SpeechRec('ko-KR', function () {
        if (recognition.resultValue) {
          summaryBox.innerHTML += recognition.resultString + '<br>';
        }
      });
      let recognitionStarted = false;

      // JSON 데이터 로드
      fetch('data.json')
        .then(response => response.json())
        .then(data => {
          data.forEach((paragraph, index) => {
            const container = document.createElement('div');
            container.className = 'text-block-container';

            const div = document.createElement('div');
            div.className = 'text-block';
            div.setAttribute('draggable', 'true');
            div.innerHTML = `${paragraph.trim()}`;

            const tooltip = document.createElement('span');
            tooltip.className = 'tooltip';
            tooltip.innerText = `no.${index + 1}`;

            container.appendChild(div);
            container.appendChild(tooltip);
            contentDiv.appendChild(container);

            // 드래그 시작 이벤트 리스너
            div.addEventListener('dragstart', function (e) {
              e.dataTransfer.setData('text/plain', paragraph.trim());
              e.target.classList.add('dragging');
            });

            // 드래그 종료 이벤트 리스너
            div.addEventListener('dragend', function (e) {
              e.target.classList.remove('dragging');
            });
          });
        });

      const bottomContainer = document.getElementById('bottom-container');

      // 드래그 오버 이벤트 리스너
      bottomContainer.addEventListener('dragover', function (e) {
        e.preventDefault();
      });

      let dragCounter = 0; // 드래그된 텍스트 블록 수

      // 드롭 이벤트 리스너
      bottomContainer.addEventListener('drop', function (e) {
        e.preventDefault();
        const data = e.dataTransfer.getData('text/plain');
        const draggingElement = document.querySelector('.text-block.dragging');
        if (draggingElement) {
          if (bottomText.innerHTML.includes('Drop text here...')) {
            bottomText.innerHTML = '';
          }
          const newElement = document.createElement('span');
          newElement.innerHTML = data + '<br>';
          bottomText.appendChild(newElement);
          draggingElement.parentElement.remove();
        }
      });

      // 요약 텍스트 함수 (백엔드 호출)
      async function summarizeText(inputText) {
        const prompt = `다음 글을 요약해주세요:\n\n${inputText}`;

        try {
          const response = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${OPENAI_API_KEY}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              model: 'gpt-3.5-turbo',
              messages: [
                { role: 'system', content: '요약해야할 문단을 절반으로 요약한다.' },
                { role: 'user', content: prompt }
              ],
              max_tokens: 600,
              temperature: 0.1,
              top_p: 0.5,
              n: 1,
              stop: null
            })
          });

          if (!response.ok) {
            const errorDetails = await response.json();
            throw new Error(`Error: ${response.status} ${response.statusText} - ${errorDetails.error.message}`);
          }

          const data = await response.json();
          return data.choices[0].message.content.trim();
        } catch (error) {
          console.error('Error:', error);
          return `Error: ${error.message}`;
        }
      }

      // 듣기 버튼 클릭 이벤트 리스너 추가
      listenButton.addEventListener('click', function () {
        listeningMode = true;
        if (!recognitionStarted) {
          recognition.start(true, false);
          recognitionStarted = true;
        }
      });

      // 요약 버튼 클릭 이벤트 리스너 추가
      summarizeButton.addEventListener('click', async function () {
        const inputText = summaryBox.innerText;
        const summary = await summarizeText(inputText);
        summaryBox.innerText = summary;
      });

      // 버튼 클릭 시 요약된 텍스트를 p5.Speech로 음성 변환
      speakButton.addEventListener('click', async function () {
        const text = bottomText.innerText;
        const summary = await summarizeText(text);

        if (summary) {
          try {
            pausedText = summary;
            isPaused = false;

            // 요약된 후 #bottom-text의 내용을 삭제
            bottomText.innerHTML = '';

            // 문장을 하나씩 쓰기 위한 변수
            const sentences = summary.split('. ').filter(sentence => sentence.trim() !== '');
            let currentSentenceIndex = 0;

            // Speech 이벤트 설정
            speech.onEnd = function () {
              if (currentSentenceIndex < sentences.length) {
                currentSentenceIndex++;
                if (currentSentenceIndex < sentences.length) {
                  speech.speak(sentences[currentSentenceIndex]);
                }
              }
            };

            // 처음 문장을 말하기 시작
            if (sentences.length > 0) {
              speech.speak(sentences[0]);
            }

            // 듣기 모드가 활성화된 경우 음성 인식을 시작
            if (listeningMode && !recognitionStarted) {
              recognition.start(true, false);
              recognitionStarted = true;
            }

          } catch (error) {
            console.error('Error during speech:', error);
          }
        } else {
          console.error('Summarization failed, not attempting to speak.');
        }
      });

      // 멈추기 버튼 클릭 이벤트 리스너 추가
      stopButton.addEventListener('click', function () {
        speech.stop();
        if (recognitionStarted) {
          recognition.stop();
          recognitionStarted = false;
        }
        isPaused = true;
      });
    });

    window.addEventListener('scroll', function () {
      const bottomContainer = document.getElementById('bottom-container');
      const scrollTop = window.scrollY || document.documentElement.scrollTop;

      // 스크롤 높이에 따라 컨테이너를 이동시키는 로직
      if (scrollTop > 0) {
        bottomContainer.style.transform = `translateY(-${scrollTop}px)`;
      } else {
        bottomContainer.style.transform = 'translateY(0)';
      }
    });

  </script>

</body>

</html>
